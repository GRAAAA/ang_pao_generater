<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>ANGPAO MAKER ‚Ä¢ 888</title>
    <link href="https://fonts.googleapis.com/css2?family=Anton&family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js"></script>
    
    <style>
        :root {
            --bg-red: #C8102E;
            --pop-blue: #00A8E8;
            --pop-yellow: #FFCC00;
            --ink-black: #1A1A1A;
            --paper-white: #FDF6E3;
            --gold: linear-gradient(135deg, #F4D03F, #E67E22, #F4D03F);
            --gold-dark: #B8860B;
            --crimson: #9B1C2C;
            --accent-green: #00C853;
            --shadow-soft: 0 10px 32px rgba(0,0,0,0.24);
            --shadow-envelope: 0 14px 40px rgba(0,0,0,0.28);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            margin: 0;
            background: var(--bg-red);
            font-family: 'Anton', sans-serif;
            color: var(--ink-black);
            min-height: 100dvh;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background-image: 
                radial-gradient(circle at 15% 25%, rgba(255, 204, 0, 0.10) 0%, transparent 60%),
                radial-gradient(circle at 85% 75%, rgba(255, 204, 0, 0.10) 0%, transparent 60%);
            animation: bg-pulse 8s ease-in-out infinite;
        }

        @keyframes bg-pulse {
            0%, 100% { background-size: 100% 100%; }
            50% { background-size: 110% 110%; }
        }

        html, body {
            height: 100%;
            overscroll-behavior: none;
        }

        /* TYPOGRAPHY */
        h1, h2, h3 { 
            text-transform: uppercase; 
            margin: 0; 
            line-height: 0.88; 
            letter-spacing: -1.5px;
            font-weight: 700;
        }
        .text-blue { 
            color: var(--pop-blue); 
            text-shadow: 4px 4px 0 var(--ink-black); 
            animation: text-wiggle 2s ease-in-out infinite;
        }
        .text-yellow { 
            color: var(--pop-yellow); 
            text-shadow: 4px 4px 0 var(--ink-black); 
            animation: text-bounce 1.5s ease-in-out infinite;
        }

        @keyframes text-wiggle {
            0%, 100% { transform: rotate(-1deg); }
            50% { transform: rotate(1deg); }
        }

        @keyframes text-bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        button {
            background: var(--pop-yellow);
            border: 5px solid var(--ink-black);
            box-shadow: 8px 8px 0 var(--ink-black);
            padding: 12px 28px;
            font-family: 'Anton', sans-serif;
            font-size: clamp(1.1rem, 4.5vw, 1.4rem);
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
            text-transform: uppercase;
            position: relative;
            overflow: hidden;
            border-radius: 8px;
            min-height: 48px;
            touch-action: manipulation;
            animation: button-pulse 2s ease-in-out infinite;
        }

        @keyframes button-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        button::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.3), transparent);
            opacity: 0;
            transition: opacity 0.3s;
        }
        button:hover::before { opacity: 1; }
        button:hover { 
            animation: button-shake 0.5s ease-in-out infinite;
        }
        button:active { 
            transform: scale(0.95) translate(3px, 3px) rotate(5deg); 
            box-shadow: 3px 3px 0 var(--ink-black); 
        }

        @keyframes button-shake {
            0%, 100% { transform: rotate(-3deg) scale(1.08); }
            50% { transform: rotate(3deg) scale(1.08); }
        }

        /* SCREENS */
        .screen {
            min-height: 100dvh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 10px;
            position: relative;
            transition: all 0.6s cubic-bezier(0.23, 1, 0.32, 1);
            gap: 8px;
        }
        .hidden { display: none !important; }

        /* HERO - MEGA ENHANCED */
        #hero-text {
            font-size: clamp(10vw, 13vw, 72px);
            text-align: center;
            transform: skewY(-7deg) rotate(-3deg);
            margin-bottom: 16px;
            animation: hero-crazy 2s ease-in-out infinite;
            text-shadow: 10px 10px 0 var(--ink-black), -2px -2px 0 var(--pop-yellow);
        }
        @keyframes hero-crazy {
            0% { transform: skewY(-7deg) rotate(-3deg) translateY(0) scale(1); }
            25% { transform: skewY(-9deg) rotate(3deg) translateY(-15px) scale(1.05); }
            50% { transform: skewY(-5deg) rotate(-5deg) translateY(-25px) scale(1.08); }
            75% { transform: skewY(-9deg) rotate(4deg) translateY(-15px) scale(1.05); }
            100% { transform: skewY(-7deg) rotate(-3deg) translateY(0) scale(1); }
        }

        /* 3D ENVELOPE - MAKER - MOBILE OPTIMIZED */
        .editor-container {
            perspective: 1600px;
            width: min(240px, 75vw);
            height: min(360px, 100vw);
            margin: 8px 0;
            filter: drop-shadow(var(--shadow-envelope));
            animation: container-float 4s ease-in-out infinite;
        }

        @keyframes container-float {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            33% { transform: translateY(-10px) rotate(2deg); }
            66% { transform: translateY(5px) rotate(-2deg); }
        }

        .angpao-card {
            width: 100%;
            height: 100%;
            background: linear-gradient(145deg, var(--crimson), #7A1422);
            border: 5px solid var(--ink-black);
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.18s cubic-bezier(0.23, 1, 0.32, 1);
            box-shadow: var(--shadow-soft);
            border-radius: 16px;
            overflow: hidden;
            animation: card-shimmer 3s linear infinite;
        }

        @keyframes card-shimmer {
            0% { filter: hue-rotate(0deg) brightness(1); }
            50% { filter: hue-rotate(5deg) brightness(1.1); }
            100% { filter: hue-rotate(0deg) brightness(1); }
        }

        .angpao-flap {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 44%;
            background: linear-gradient(145deg, var(--crimson), #7A1422);
            clip-path: polygon(0 0, 50% 82%, 100% 0);
            border: 5px solid var(--ink-black);
            border-bottom: none;
            z-index: 10;
            box-shadow: 0 12px 24px rgba(0,0,0,0.4);
            transform-origin: top;
            transition: transform 0.4s ease;
            animation: flap-tease 4s ease-in-out infinite;
        }

        @keyframes flap-tease {
            0%, 100% { transform: rotateX(0deg); }
            50% { transform: rotateX(-8deg); }
        }

        .angpao-pattern {
            position: absolute;
            top: 36px;
            left: 18px;
            right: 18px;
            bottom: 70px;
            border: 3px solid var(--gold-dark);
            opacity: 0.22;
            pointer-events: none;
            z-index: 5;
            background: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 10px,
                rgba(255,215,0,0.07) 10px,
                rgba(255,215,0,0.07) 20px
            );
            animation: pattern-spin 20s linear infinite;
        }

        @keyframes pattern-spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        #drawing-canvas {
            position: absolute;
            top: 36px;
            left: 18px;
            right: 18px;
            bottom: 70px;
            width: calc(100% - 36px);
            height: calc(100% - 106px);
            image-rendering: pixelated;
            cursor: default;
            z-index: 8;
            background: rgba(255,255,255,0.08);
            box-shadow: inset 0 0 36px rgba(0,0,0,0.3);
            touch-action: none;
            pointer-events: none;
        }

        /* TOOLS - COMPACT FOR MOBILE */
        .tools {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 8px;
            margin-top: 8px;
            background: white;
            padding: 8px 12px;
            border: 4px solid var(--ink-black);
            box-shadow: var(--shadow-soft);
            border-radius: 12px;
            max-width: 100%;
            animation: tools-wiggle 3s ease-in-out infinite;
        }

        @keyframes tools-wiggle {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-1deg); }
            75% { transform: rotate(1deg); }
        }

        .color-btn {
            width: 36px; 
            height: 36px; 
            border: 3px solid var(--ink-black);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.25s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            box-shadow: 0 3px 0 var(--ink-black);
            animation: color-dance 2s ease-in-out infinite;
        }

        @keyframes color-dance {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-3px) rotate(5deg); }
        }

        .color-btn:hover { 
            transform: scale(1.3) rotate(15deg); 
            animation: color-spin 0.5s linear infinite;
        }
        .color-btn:active { transform: scale(0.9) rotate(-15deg); }

        @keyframes color-spin {
            from { transform: rotate(0deg) scale(1.3); }
            to { transform: rotate(360deg) scale(1.3); }
        }

        /* FORM - COMPACT */
        .form-box {
            background: white;
            padding: 16px 18px;
            border: 5px solid var(--ink-black);
            box-shadow: var(--shadow-soft);
            width: 100%;
            max-width: 340px;
            border-radius: 16px;
            animation: form-breathe 3s ease-in-out infinite;
        }

        @keyframes form-breathe {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        input, textarea {
            width: 100%;
            border: 4px solid var(--ink-black);
            padding: 10px 14px;
            font-family: 'Inter', sans-serif;
            margin-bottom: 10px;
            font-size: 1rem;
            background: #f9f9f9;
            transition: all 0.25s;
            border-radius: 8px;
        }
        input:focus, textarea:focus {
            outline: none;
            box-shadow: 0 0 0 5px var(--pop-yellow);
            transform: translateY(-2px) scale(1.02);
            animation: input-rainbow 2s linear infinite;
        }

        @keyframes input-rainbow {
            0% { border-color: #FF2D55; }
            25% { border-color: #00A8E8; }
            50% { border-color: #00C853; }
            75% { border-color: #FFCC00; }
            100% { border-color: #FF2D55; }
        }

        /* RECEIVER - 3D ENVELOPE + FOLDED LETTER */
        .envelope-wrapper {
            position: relative;
            width: min(240px, 75vw);
            height: min(360px, 100vw);
            cursor: pointer;
            perspective: 1600px;
            margin: 12px 0;
            animation: wrapper-bounce 2s ease-in-out infinite;
        }

        @keyframes wrapper-bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-12px); }
        }

        .closed-envelope {
            width: 100%;
            height: 100%;
            background: linear-gradient(145deg, var(--crimson), #7A1422);
            border: 5px solid var(--ink-black);
            position: absolute;
            z-index: 10;
            transition: all 1.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            box-shadow: var(--shadow-envelope);
            border-radius: 16px;
            overflow: hidden;
        }
        .closed-envelope.glowing {
            animation: envelope-glow 1s ease-in-out infinite alternate, envelope-disco 0.3s linear infinite;
        }
        @keyframes envelope-glow {
            from { box-shadow: var(--shadow-envelope), 0 0 80px 30px rgba(255, 204, 0, 0.7); }
            to   { box-shadow: var(--shadow-envelope), 0 0 140px 50px rgba(255, 204, 0, 0.95); }
        }

        @keyframes envelope-disco {
            0% { filter: hue-rotate(0deg); }
            100% { filter: hue-rotate(360deg); }
        }

        .envelope-flap {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 44%;
            background: linear-gradient(145deg, var(--crimson), #7A1422);
            clip-path: polygon(0 0, 50% 82%, 100% 0);
            border: 5px solid var(--ink-black);
            border-bottom: none;
            z-index: 20;
            box-shadow: 0 14px 28px rgba(0,0,0,0.45);
            transform-origin: top center;
            transition: transform 1.4s cubic-bezier(0.6, 0.04, 0.1, 1);
        }
        #envelope-design-container {
            position: absolute;
            top: 36px;
            left: 18px;
            right: 18px;
            bottom: 70px;
            z-index: 8;
            border: 3px solid var(--gold-dark);
            overflow: hidden;
            box-shadow: inset 0 0 40px rgba(0,0,0,0.35);
        }

        /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
           UPDATED LETTER LOGIC (NOTEBOOK OPENING STYLE)
           This fixes the "half-split" bug by using a hinged cover.
           ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        .money-letter {
            position: absolute;
            inset: 0;
            width: 100%;
            background: var(--paper-white);
            border: 5px solid var(--ink-black);
            display: flex;
            flex-direction: column;
            z-index: 5;
            box-shadow: var(--shadow-soft);
            
            /* Initial State: Hidden and Small */
            opacity: 0;
            transform: scale(0.6) translateY(50px) rotate(5deg);
            height: 200px; /* Small height when folded */
            
            transition: 
                opacity 0.5s ease,
                transform 0.8s cubic-bezier(0.34, 1.56, 0.64, 1),
                height 0.8s cubic-bezier(0.23, 1, 0.32, 1); /* Smooth height growth */
            
            border-radius: 14px;
            perspective: 1500px; /* Essential for the 3D flip */
            transform-style: preserve-3d;
        }

        /* 1. Revealed State (popped out of envelope, but still closed) */
        .money-letter.revealed {
            opacity: 1;
            transform: scale(0.9) translateY(0) rotate(0deg);
            z-index: 100; /* Ensure it's above everything */
            cursor: pointer;
        }

        /* 2. Unfolded State (Clicked -> Opens up) */
        .money-letter.unfolded {
            height: 100%; /* Grows to full container height */
            transform: scale(1) translateY(0) rotate(0deg);
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
            cursor: default;
        }

        /* THE COVER FLAP (The part that flips up) */
        .letter-cover {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 200px; /* Matches the folded height */
            background: var(--paper-white);
            border-bottom: 4px dashed #ccc;
            z-index: 50;
            transform-origin: top; /* Hinges at the top */
            transition: transform 0.9s cubic-bezier(0.4, 0, 0.2, 1);
            backface-visibility: hidden; /* Hides it when fully open */
            
            /* Center the "From" text */
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            border-radius: 10px 10px 0 0;
        }

        /* Rotate the cover when unfolded */
        .money-letter.unfolded .letter-cover {
            transform: rotateX(160deg);
            box-shadow: 0 -10px 20px rgba(0,0,0,0.1); /* Shadow for depth */
        }

        /* Styling inside the Cover */
        .teaser-text {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--ink-black);
            text-transform: uppercase;
            transform: rotate(-3deg);
            text-align: center;
        }

        /* THE INSIDE CONTENT (Hidden until unfolded) */
        .full-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 24px 20px;
            padding-top: 40px; /* Space for the hinge */
            opacity: 0;
            transition: opacity 0.5s ease;
            overflow-y: auto;
            gap: 16px;
        }

        /* Show content when unfolded */
        .money-letter.unfolded .full-content {
            opacity: 1;
            transition-delay: 0.3s; /* Wait for flip to start */
        }

        .money-amount {
            font-size: clamp(2.4rem, 8vw, 3.2rem);
            font-weight: 700;
            color: var(--accent-green);
            text-align: center;
            border-bottom: 4px dashed var(--accent-green);
            padding-bottom: 12px;
            text-shadow: 3px 3px 0 #fff, -1px -1px 0 #fff;
            animation: money-flash 1s ease-in-out infinite;
        }

        @keyframes money-flash {
            0%, 100% { transform: scale(1); color: var(--accent-green); }
            50% { transform: scale(1.1); color: #FFD700; }
        }

        #display-msg {
            word-break: break-word;
            font-size: clamp(1.05rem, 4vw, 1.2rem);
            line-height: 1.5;
            color: #333;
            background: rgba(255,255,255,0.6);
            padding: 15px;
            border-radius: 8px;
            border: 2px solid rgba(0,0,0,0.05);
        }

        /* ANIMATIONS */
        .shake {
            animation: envelope-shake-crazy 0.5s cubic-bezier(0.36,0.07,0.19,0.97) both infinite;
        }
        @keyframes envelope-shake-crazy {
            0%, 100% { transform: rotate(-5deg) scale(1.025); }
            10% { transform: rotate(6deg) scale(1.025) translateX(-3px); }
            20% { transform: rotate(-7deg) scale(1.025) translateX(3px); }
            30% { transform: rotate(8deg) scale(1.025) translateY(-3px); }
            40% { transform: rotate(-6deg) scale(1.025) translateY(3px); }
            50% { transform: rotate(7deg) scale(1.025) translateX(-3px); }
            60% { transform: rotate(-8deg) scale(1.025) translateX(3px); }
            70% { transform: rotate(6deg) scale(1.025) translateY(-3px); }
            80% { transform: rotate(-7deg) scale(1.025) translateY(3px); }
            90% { transform: rotate(5deg) scale(1.025); }
        }

        .opening {
            transform: translateX(-145%) rotate(-26deg) scale(0.82) !important;
            transition: transform 1.1s cubic-bezier(0.68, -0.55, 0.265, 1.55) !important;
            animation: opening-spin 1s linear forwards !important;
        }

        @keyframes opening-spin {
            0% { transform: translateX(0) rotate(0deg) scale(1); }
            100% { transform: translateX(-145%) rotate(-386deg) scale(0.82); }
        }

        .decoration-sticker {
            position: absolute;
            background: var(--pop-yellow);
            color: var(--ink-black);
            padding: 6px 14px;
            font-size: 0.9rem;
            border: 4px solid var(--ink-black);
            border-radius: 40px;
            box-shadow: 6px 6px 0 var(--ink-black);
            font-weight: 700;
            animation: sticker-crazy 2s ease-in-out infinite;
        }
        @keyframes sticker-crazy {
            0%, 100% { transform: rotate(-12deg) translateY(0) scale(1); }
            25% { transform: rotate(-20deg) translateY(-10px) scale(1.1); }
            50% { transform: rotate(-5deg) translateY(-15px) scale(1.15); }
            75% { transform: rotate(-18deg) translateY(-8px) scale(1.08); }
        }

        /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
           MOBILE RESPONSIVE ADJUSTMENTS
        ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        @media (max-width: 480px) {
            .screen {
                padding: 8px;
                gap: 6px;
            }

            #hero-text {
                font-size: clamp(11vw, 14vw, 68px);
                margin-bottom: 12px;
            }

            h2 {
                font-size: 2rem !important;
                margin-bottom: 6px !important;
            }

            p {
                font-size: 0.95rem !important;
                margin-bottom: 8px !important;
            }

            button {
                padding: 10px 24px;
                font-size: 1.15rem;
                min-height: 44px;
            }

            .tools {
                padding: 6px 10px;
                gap: 6px;
            }

            .color-btn {
                width: 34px;
                height: 34px;
            }

            .form-box {
                padding: 14px 16px;
            }

            input, textarea {
                padding: 9px 12px;
                font-size: 0.95rem;
                margin-bottom: 8px;
            }

            .money-amount {
                font-size: 2.4rem;
            }

            .decoration-sticker {
                padding: 5px 12px;
                font-size: 0.85rem;
            }
        }

        @media (max-height: 700px) {
            .screen {
                justify-content: flex-start;
                padding-top: 12px;
                min-height: auto;
            }

            .editor-container,
            .envelope-wrapper {
                margin: 6px 0;
            }

            #hero-text {
                margin-bottom: 8px;
            }
        }

        /* MONEY RAIN CONTAINER */
        #money-rain {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
            overflow: hidden;
        }

        .money {
            position: absolute;
            font-size: 28px;
            color: #00C853;
            opacity: 0.9;
            animation: fall-crazy linear forwards;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        @keyframes fall-crazy {
            0% { transform: translateY(-50px) rotate(0deg) scale(1); }
            25% { transform: translateY(25vh) rotate(90deg) scale(1.3); }
            50% { transform: translateY(50vh) rotate(180deg) scale(0.8); }
            75% { transform: translateY(75vh) rotate(270deg) scale(1.5); }
            100% { transform: translateY(120vh) rotate(720deg) scale(0.5); opacity: 0; }
        }

        /* MEME CONTAINER - COMPACT */
        #meme-container {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding: 8px 0;
            margin-top: 10px;
            scrollbar-width: none;
        }

        #meme-container::-webkit-scrollbar {
            display: none;
        }
    </style>
</head>
<body>

    <div id="landing-page" class="screen">
        <h1 id="hero-text" class="text-blue">ANGPAO<br><span class="text-yellow">888</span></h1>
        <div style="font-family: 'Inter'; margin-bottom: 20px; font-size: 1.2rem; font-weight: 700; letter-spacing: 1.5px; color: rgba(255,255,255,0.95);">SEND GOOD FORTUNE</div>
        <div style="font-family: 'Inter'; margin-bottom: 5px; font-size: 0.5rem; font-weight: 700; letter-spacing: 1.5px; color: rgba(255,255,255,0.95);">by GRAAAA</div>
        <button onclick="goToMaker()">MAKE ONE NOW</button>
        
        <div class="decoration-sticker" style="top: 20px; left: 20px; transform: rotate(-12deg)">Á¶è</div>
        <div class="decoration-sticker" style="bottom: 20px; right: 20px; background: var(--pop-blue); color: white; transform: rotate(8deg)">PROSPERITY</div>
    </div>

    <div id="maker-page" class="screen hidden">
        <h2 class="text-yellow" style="margin-bottom: 6px; font-size: 2.4rem;">DESIGN YOURS</h2>
        <p style="font-family:'Inter'; color:white; font-size: 0.95rem; margin-bottom: 8px;">Drag to rotate ‚Ä¢ Pick color</p>
        
        <div class="editor-container" id="editor-container">
            <div class="angpao-card" id="angpao-card">
                <div class="angpao-flap"></div>
                <div class="angpao-pattern"></div>
                <canvas id="drawing-canvas" width="204" height="254"></canvas>
            </div>
        </div>

        <div class="tools">
            <div class="color-btn" style="background: #C8102E;" onclick="setEnvelopeColor('#C8102E')"></div>
            <div class="color-btn" style="background: #9B1C2C;" onclick="setEnvelopeColor('#9B1C2C')"></div>
            <div class="color-btn" style="background: #B22222;" onclick="setEnvelopeColor('#B22222')"></div>
            <div class="color-btn" style="background: #8B0000;" onclick="setEnvelopeColor('#8B0000')"></div>
            <div class="color-btn" style="background: #DC143C;" onclick="setEnvelopeColor('#DC143C')"></div>
            <div class="color-btn" style="background: #FF4500;" onclick="setEnvelopeColor('#FF4500')"></div>
        </div>

        <button onclick="goToForm()" style="margin-top: 8px;">SEAL IT</button>
    </div>

    <div id="form-page" class="screen hidden">
        <h2 class="text-blue" style="font-size: 2.4rem; margin-bottom: 16px;">FILL THE BLESSING</h2>
        
        <div class="form-box">
            <label style="font-size: 0.95rem; display: block; margin-bottom: 4px;">FROM</label>
            <input type="text" id="input-from" placeholder="Your name">
            
            <label style="font-size: 0.95rem; display: block; margin-bottom: 4px;">TO</label>
            <input type="text" id="input-to" placeholder="Friend's name">
            
            <label style="font-size: 0.95rem; display: block; margin-bottom: 4px;">AMOUNT (RM)</label>
            <input type="number" id="input-amount" placeholder="88.88" step="0.01">
            
            <label style="font-size: 0.95rem; display: block; margin-bottom: 4px;">MESSAGE</label>
            <textarea id="input-msg" rows="2" placeholder="Gong Xi Fa Cai! May your year be filled with luck."></textarea>

            <button style="width: 100%; margin-top: 8px;" onclick="generateAngpao()">SEAL & SEND</button>
        </div>
    </div>

    <div id="share-page" class="screen hidden">
        <h2 class="text-yellow" style="font-size: 2.8rem; margin-bottom: 10px;">IT'S READY!</h2>
        <p style="font-family:'Inter'; font-weight:700; font-size: 1.1rem; margin-bottom: 16px; max-width: 300px; text-align: center;">
            Share this link with your friend
        </p>
        
        <input type="text" id="share-link" readonly style="text-align: center; font-size: 0.95rem; padding: 14px;">
        <button onclick="copyLink()" style="margin-top: 12px;">COPY LINK</button>
        <button style="background: white; color: var(--ink-black); margin-top: 8px;" onclick="openPreview()">PREVIEW OPENING</button>
    </div>

    <div id="receiver-page" class="screen hidden">
        <h2 id="receiver-title" class="text-blue" style="margin-bottom: 16px; font-size: 2rem; text-align: center;"></h2>
        
        <div class="envelope-wrapper" id="envelope-wrapper">
            <div class="closed-envelope" id="envelope-cover">
                <div class="envelope-flap" id="envelope-flap"></div>
                <div id="envelope-design-container"></div>
                <h1 id="open-text" class="text-yellow" style="font-size: 3.8rem; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-12deg); z-index: 30; text-shadow: 8px 8px 0 var(--ink-black);">OPEN</h1>
            </div>

            <div class="money-letter" id="letter-content" onclick="toggleFold()">
                
                <div class="letter-cover">
                    <div class="teaser-text">
                        <div style="font-size: 0.9rem; font-family:'Inter'; opacity:0.7; margin-bottom:5px;">A GIFT FROM</div>
                        <span id="display-from-teaser"></span>
                    </div>
                </div>

                <div class="full-content">
                    <h3 style="font-size: 1.3rem; color: #444; margin-bottom: 4px;">
                        FROM: <span id="display-from" style="color: var(--ink-black);"></span>
                    </h3>
                    
                    <div class="money-amount">RM <span id="display-amount"></span></div>
                    
                    <p id="display-msg"></p>

                    <div id="meme-container" style="margin-top: 16px;"></div>

                    <button onclick="location.href=window.location.pathname" style="margin-top: auto; font-size:1rem; min-height:40px; padding:10px;">SEND ONE BACK</button>
                </div>
            </div>
        </div>
    </div>

    <div id="money-rain"></div>

    <script>
        /* GLOBAL STATE */
        let isRotating = false;
        let envelopeColor = '#C8102E';
        let isUnfolded = false; // Tracks if the letter is open

        function setEnvelopeColor(c) {
            envelopeColor = c;
            document.getElementById('angpao-card').style.background = `linear-gradient(145deg, ${c}, #7A1422)`;
            confetti({
                particleCount: 20,
                spread: 40,
                origin: { y: 0.7 },
                colors: [c]
            });
        }

        /* NEW FOLD LOGIC: NOTEBOOK FLIP */
        function toggleFold() {
            const letter = document.getElementById('letter-content');
            isUnfolded = !isUnfolded;

            if (isUnfolded) {
                // OPEN IT
                letter.classList.add('unfolded');
                
                // Visual flare
                confetti({
                    particleCount: 40,
                    spread: 70,
                    origin: { y: 0.6 },
                    colors: ['#00C853', '#FFCC00']
                });
            } else {
                // CLOSE IT (Optional, if user wants to close)
                letter.classList.remove('unfolded');
            }
        }

        /* NAV */
        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => {
                s.style.opacity = '0';
                setTimeout(() => {
                    s.classList.add('hidden');
                    if (s.id === id) {
                        s.classList.remove('hidden');
                        s.style.opacity = '1';
                    }
                }, 400);
            });
        }

        function goToMaker() { 
            showScreen('maker-page'); 
            triggerScreenConfetti();
        }
        function goToForm() { 
            showScreen('form-page'); 
            triggerScreenConfetti();
        }

        function triggerScreenConfetti() {
            confetti({
                particleCount: 50,
                spread: 70,
                origin: { y: 0.6 },
                colors: ['#FFCC00', '#00A8E8', '#FF2D55']
            });
        }

        /* 3D INTERACTION - ENHANCED WITH TOUCH */
        function add3DInteraction(containerId, targetId) {
            const container = document.getElementById(containerId);
            const target = document.getElementById(targetId);
            if (!container || !target) return;

            let startX = 0, startY = 0;

            function updateRotation(clientX, clientY) {
                const rect = container.getBoundingClientRect();
                const x = (clientX - rect.left) / rect.width;
                const y = (clientY - rect.top) / rect.height;
                
                const rotateY = (x - 0.5) * 42;
                const rotateX = (0.5 - y) * 36;
                
                target.style.transform = `rotateX(${rotateX}deg) rotateY(${rotateY}deg)`;
            }

            container.addEventListener('mousedown', (e) => {
                if (e.target.closest('#drawing-canvas')) return;
                isRotating = true;
                target.style.transition = 'none';
            });
            document.addEventListener('mousemove', (e) => {
                if (!isRotating) return;
                updateRotation(e.clientX, e.clientY);
            });
            document.addEventListener('mouseup', () => {
                if (isRotating) {
                    isRotating = false;
                    reset3D(target);
                }
            });

            container.addEventListener('touchstart', (e) => {
                if (e.touches.length === 1 && e.target.closest('#drawing-canvas')) return;
                isRotating = true;
                target.style.transition = 'none';
                e.preventDefault();
            }, { passive: false });
            container.addEventListener('touchmove', (e) => {
                if (!isRotating || e.touches.length !== 1) return;
                updateRotation(e.touches[0].clientX, e.touches[0].clientY);
                e.preventDefault();
            }, { passive: false });
            container.addEventListener('touchend', () => {
                if (isRotating) {
                    isRotating = false;
                    reset3D(target);
                }
            });
        }

        function reset3D(target) {
            target.style.transition = 'transform 0.75s cubic-bezier(0.23, 1, 0.32, 1)';
            target.style.transform = 'rotateX(0deg) rotateY(0deg)';
            setTimeout(() => target.style.transition = '', 800);
        }

        /* COMPRESSION HELPERS */
        function compressToUrlSafe(str) {
            const uint8 = new TextEncoder().encode(str);
            const compressed = pako.deflate(uint8, { level: 9 });
            let binary = '';
            for (let i = 0; i < compressed.length; i++) {
                binary += String.fromCharCode(compressed[i]);
            }
            return btoa(binary)
                .replace(/\+/g, '-')
                .replace(/\//g, '_')
                .replace(/=+$/, '');
        }

        function decompressFromUrlSafe(str) {
            str = str.replace(/-/g, '+').replace(/_/g, '/');
            while (str.length % 4) str += '=';
            const binary = atob(str);
            const bytes = new Uint8Array(binary.length);
            for (let i = 0; i < binary.length; i++) {
                bytes[i] = binary.charCodeAt(i);
            }
            const decompressed = pako.inflate(bytes);
            return new TextDecoder().decode(decompressed);
        }

        /* GENERATION WITH COMPRESSION */
        function generateAngpao() {
            const from   = document.getElementById('input-from').value.trim() || "A Friend";
            const to     = document.getElementById('input-to').value.trim()   || "Lucky One";
            const amount = document.getElementById('input-amount').value      || "88.88";
            const msg    = document.getElementById('input-msg').value.trim()  || "Gong Xi Fa Cai!";

            const payload = [
                from,
                to,
                amount,
                msg,
                envelopeColor
            ];

            const json = JSON.stringify(payload);
            const compressed = compressToUrlSafe(json);
            
            const url = `${window.location.origin}${window.location.pathname}?d=${compressed}`;
            
            document.getElementById('share-link').value = url;
            showScreen('share-page');
            triggerScreenConfetti();
        }

        function copyLink() {
            const link = document.getElementById("share-link");
            link.select();
            document.execCommand("copy");
            const origText = link.value;
            link.value = "COPIED ‚úì";
            
            confetti({
                particleCount: 100,
                spread: 70,
                origin: { y: 0.6 }
            });
            
            setTimeout(() => link.value = origText, 1400);
        }

        function openPreview() {
            const from   = document.getElementById('input-from').value.trim() || "A Friend";
            const to     = document.getElementById('input-to').value.trim()   || "Lucky One";
            const amount = document.getElementById('input-amount').value      || "88.88";
            const msg    = document.getElementById('input-msg').value.trim()  || "Gong Xi Fa Cai!";

            const payload = [
                from, to, amount, msg,
                envelopeColor
            ];

            loadReceiverView(payload);
        }

        /* RECEIVER */
        function loadReceiverView(payload) {
            const [from, to, amount, msg, color] = payload;

            // Update Texts
            document.getElementById('display-from').innerText = from;
            document.getElementById('display-from-teaser').innerText = from; // Update Cover Text
            document.getElementById('receiver-title').innerText = `FOR ${to.toUpperCase()}`;
            document.getElementById('display-amount').innerText = parseFloat(amount).toFixed(2);
            document.getElementById('display-msg').innerText = msg;

            // Update Envelope Color
            const cover = document.getElementById('envelope-cover');
            cover.style.background = `linear-gradient(145deg, ${color}, #7A1422)`;

            showScreen('receiver-page');

            add3DInteraction('envelope-wrapper', 'envelope-cover');

            const coverEl = document.getElementById('envelope-cover');
            coverEl.classList.add('shake');
        }

        function openEnvelope() {
            const cover = document.getElementById('envelope-cover');
            const flap = document.getElementById('envelope-flap');
            const letter = document.getElementById('letter-content');
            const openText = document.getElementById('open-text');

            if (cover.classList.contains('opening')) return;

            cover.classList.remove('shake');
            cover.classList.add('glowing');

            flap.style.transform = 'rotateX(-142deg)';

            if (openText) {
                openText.style.transition = 'all 0.5s ease';
                openText.style.opacity = '0';
                openText.style.transform = 'translate(-50%, -50%) rotate(-12deg) scale(0.6)';
            }

            // Animate envelope flying away
            setTimeout(() => {
                cover.classList.add('opening');
            }, 280);

            // Confetti Explosion
            const colors = ['#FFCC00', '#C8102E', '#00A8E8', '#FFFFFF', '#FF2D55', '#00C853'];
            confetti({
                particleCount: 200,
                spread: 120,
                origin: { x: 0.5, y: 0.3 },
                colors: colors,
                scalar: 1.5,
                gravity: 0.7,
                ticks: 300
            });

            // Delay showing the letter slightly so it looks like it popped out
            setTimeout(() => {
                letter.classList.add('revealed');
                startMoneyRain();
            }, 740);
        }

        /* MONEY RAIN - ENHANCED */
        function startMoneyRain() {
            const rainContainer = document.getElementById('money-rain');
            rainContainer.innerHTML = '';
            
            const moneySymbols = ['üí∞', 'üíµ', 'üÄÑ', 'üßß', 'üçä', 'üßß', 'üí¥', 'üí∂', 'üí∑', 'üí∏'];
            
            for (let i = 0; i < 60; i++) {
                const money = document.createElement('div');
                money.className = 'money';
                money.textContent = moneySymbols[Math.floor(Math.random() * moneySymbols.length)];
                money.style.left = Math.random() * 100 + 'vw';
                money.style.top = '-' + (Math.random() * 100 + 50) + 'px';
                money.style.animationDuration = (Math.random() * 2 + 2) + 's';
                money.style.animationDelay = Math.random() * 0.8 + 's';
                money.style.fontSize = (Math.random() * 20 + 24) + 'px';
                money.style.opacity = Math.random() * 0.4 + 0.6;
                rainContainer.appendChild(money);
                
                setTimeout(() => {
                    if (money.parentNode) money.parentNode.removeChild(money);
                }, 7000);
            }
        }

        /* INIT */
        window.onload = () => {
            add3DInteraction('editor-container', 'angpao-card');

            const wrapper = document.getElementById('envelope-wrapper');
            // We only attach the click to the envelope COVER now, handled inside the div onclick
            // wrapper.addEventListener('click', openEnvelope); 
            
            // Handle wrapper click for the envelope part only
            const envCover = document.getElementById('envelope-cover');
            envCover.addEventListener('click', openEnvelope);
            envCover.addEventListener('touchend', openEnvelope);

            const urlParams = new URLSearchParams(window.location.search);
            const compressedData = urlParams.get('d');

            if (compressedData) {
                try {
                    const json = decompressFromUrlSafe(compressedData);
                    const payload = JSON.parse(json);
                    loadReceiverView(payload);
                } catch (e) {
                    console.error("Bad angpao", e);
                    showScreen('landing-page');
                }
            } else {
                showScreen('landing-page');
            }
        };
    </script>
</body>
</html>